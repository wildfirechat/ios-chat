# æ¶ˆæ¯å¤‡ä»½æ¢å¤æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ

## âš ï¸ é‡è¦çº¦æŸ

**æ‰€æœ‰æ¶ˆæ¯å’Œä¼šè¯çš„è¯»å†™æ“ä½œå¿…é¡»é€šè¿‡ `WFCCIMService` SDK æ¥å£è¿›è¡Œï¼Œç¦æ­¢ç›´æ¥è®¿é—®æ•°æ®åº“ã€‚**

è¯¦è§ï¼š[æ¶ˆæ¯å¤‡ä»½æ¢å¤åŠŸèƒ½è®¾è®¡æ–‡æ¡£.md](./æ¶ˆæ¯å¤‡ä»½æ¢å¤åŠŸèƒ½è®¾è®¡æ–‡æ¡£.md) ä¸­çš„"é‡è¦æ¶æ„çº¦æŸ"ç« èŠ‚ã€‚

### âŒ ä¸å¯è¡Œçš„ä¼˜åŒ–æ–¹æ¡ˆ

ç”±äºå¿…é¡»é€šè¿‡ SDK æ¥å£ï¼Œä»¥ä¸‹ä¼˜åŒ–æ–¹æ¡ˆ**ä¸å¯è¡Œ**ï¼š

1. **æ•°æ®åº“ç›´æ¥å¯¼å‡º**ï¼šç»•è¿‡ SDK ç›´æ¥è¯»å– SQLite
2. **æ•°æ®åº“æ–‡ä»¶å¤åˆ¶**ï¼šç›´æ¥å¤åˆ¶æ•°æ®åº“æ–‡ä»¶
3. **æ‰¹é‡ SQL æ’å…¥**ï¼šç»•è¿‡ SDK ç›´æ¥å†™å…¥æ•°æ®åº“

### âœ… å¯è¡Œçš„ä¼˜åŒ–æ–¹æ¡ˆ

1. **æµå¼ JSON å†™å…¥**ï¼šå‡å°‘å†…å­˜å ç”¨
2. **åˆ†æ‰¹å¤„ç†**ï¼šé¿å…ä¸€æ¬¡æ€§åŠ è½½å…¨éƒ¨æ•°æ®
3. **å¹¶è¡Œå¤„ç†**ï¼šå¤šçº¿ç¨‹å¤„ç†ä¸åŒä¼šè¯
4. **å‹ç¼©è¾“å‡º**ï¼šå‡å°‘æ–‡ä»¶å¤§å°
5. **å¢é‡å¤‡ä»½**ï¼šåªå¤‡ä»½å˜æ›´æ•°æ®

---

## é—®é¢˜åˆ†æ

### å½“å‰è®¾è®¡çš„æ€§èƒ½ç“¶é¢ˆ

å½“æ¶ˆæ¯é‡è¾¾åˆ° 10 ä¸‡+ æ¡æ—¶ï¼š

| é—®é¢˜ | å½±å“ | åŸå›  |
|------|------|------|
| å†…å­˜å³°å€¼è¿‡é«˜ | å¯èƒ½å¯¼è‡´ OOM å´©æºƒ | ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰æ•°æ®åˆ°å†…å­˜ |
| JSON åºåˆ—åŒ–æ…¢ | å¤‡ä»½æ—¶é—´é•¿ | `NSJSONSerialization` ä¸€æ¬¡æ€§å¤„ç† |
| æ— æ³•æš‚åœæ¢å¤ | ç”¨æˆ·ä½“éªŒå·® | å¿…é¡»ä¸€æ¬¡æ€§å®Œæˆ |
| æ–‡ä»¶ä½“ç§¯å¤§ | å ç”¨å­˜å‚¨ç©ºé—´ | JSON å†—ä½™åº¦é«˜ |
| å•çº¿ç¨‹å¤„ç† | CPU åˆ©ç”¨ç‡ä½ | æœªå……åˆ†åˆ©ç”¨å¤šæ ¸ |

### å®é™…æµ‹è¯•æ•°æ®ï¼ˆé¢„ä¼°ï¼‰

| æ¶ˆæ¯æ•°é‡ | ä»…æ¶ˆæ¯å¤‡ä»½ | å®Œæ•´å¤‡ä»½ | å†…å­˜å ç”¨ | æ–‡ä»¶å¤§å° |
|---------|----------|---------|---------|---------|
| 1,000 | ~2ç§’ | ~5ç§’ | ~50MB | ~500KB |
| 10,000 | ~30ç§’ | ~2åˆ†é’Ÿ | ~200MB | ~5MB |
| 100,000 | ~5åˆ†é’Ÿ | ~15åˆ†é’Ÿ | ~1.5GB | ~50MB |
| 1,000,000 | ~60åˆ†é’Ÿ | ~3å°æ—¶ | ~10GB+ | ~500MB |

*æ³¨ï¼šæ•°æ®åŸºäº iPhone 12 è®¾å¤‡é¢„ä¼°*

---

## ä¼˜åŒ–æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šæµå¼ JSON å†™å…¥ï¼ˆæ¨èï¼‰âœ…

**æ ¸å¿ƒæ€è·¯**ï¼šä¸æ„å»ºå®Œæ•´çš„å­—å…¸å¯¹è±¡ï¼Œç›´æ¥æµå¼å†™å…¥ JSON

#### å®ç°æ–¹å¼

ä½¿ç”¨ `NSJSONSerialization` çš„ `writingStream` æˆ–æ‰‹åŠ¨æ‹¼æ¥ JSON

```objc
- (void)createMessageOnlyBackupStreaming:(NSString *)filePath
                                progress:(void(^)(NSProgress *))progress
                                 success:(void(^)(NSString *))success
                                   error:(void(^)(int))error {

    // åˆ›å»ºè¾“å‡ºæµ
    NSOutputStream *outputStream = [NSOutputStream outputStreamToFileAtPath:filePath append:NO];
    [outputStream scheduleInRunLoop:[NSRunLoop currentRunLoop] forMode:NSDefaultRunLoopMode];
    [outputStream open];

    // 1. å†™å…¥ JSON å¤´éƒ¨
    [self writeJSONHeader:outputStream];

    // 2. æµå¼å†™å…¥ä¼šè¯å’Œæ¶ˆæ¯
    NSArray *conversationTypes = @[@(Single_Type), @(Group_Type), @(Chatroom_Type)];
    NSArray *conversations = [[WFCCIMService sharedWFCIMService] getConversationInfos:conversationTypes lines:@[@0]];

    NSProgress *parentProgress = [NSProgress progressWithTotalUnitCount:conversations.count];
    NSInteger totalMessages = [self estimateTotalMessages:conversations];
    NSProgress *msgProgress = [NSProgress progressWithTotalUnitCount:totalMessages];

    // å†™å…¥ conversations æ•°ç»„å¼€å§‹
    [self writeString:@"\"conversations\":[" toStream:outputStream];

    for (NSInteger i = 0; i < conversations.count; i++) {
        @autoreleasepool {
            WFCCConversationInfo *convInfo = conversations[i];

            // å†™å…¥ä¼šè¯å¯¹è±¡
            [self writeString:@"{" toStream:outputStream];
            [self writeJSONKeyValue:@"type" value:@(convInfo.conversation.type) toStream:outputStream];
            [self writeJSONKeyValue:@"target" value:convInfo.conversation.target toStream:outputStream];
            [self writeJSONKeyValue:@"line" value:@(convInfo.conversation.line) toStream:outputStream];
            [self writeJSONKeyValue:@"isTop" value:@(convInfo.isTop) toStream:outputStream];
            [self writeJSONKeyValue:@"isSilent" value:@(convInfo.isSilent) toStream:outputStream];
            [self writeJSONKeyValue:@"draft" value:convInfo.draft ?: @"" toStream:outputStream];

            // å†™å…¥ messages æ•°ç»„
            [self writeString:@"\"messages\":[" toStream:outputStream];

            WFCCConversation *conversation = convInfo.conversation;

            // åˆ†æ‰¹è·å–æ¶ˆæ¯ï¼Œé¿å…å†…å­˜å³°å€¼
            NSInteger fromIndex = 0;
            NSInteger batchSize = 100;
            BOOL isFirstMessage = YES;

            while (YES) {
                @autoreleasepool {
                    NSArray *messages = [[WFCCIMService sharedWFCIMService] getMessages:conversation
                                                                        contentTypes:nil
                                                                                from:fromIndex
                                                                               count:batchSize
                                                                            withUser:nil];

                    if (messages.count == 0) break;

                    // å†™å…¥è¿™ä¸€æ‰¹æ¶ˆæ¯
                    for (NSInteger j = 0; j < messages.count; j++) {
                        if (!isFirstMessage) {
                            [self writeString:@"," toStream:outputStream];
                        }
                        isFirstMessage = NO;

                        WFCCMessage *message = messages[j];
                        [self writeMessageJSON:message toStream:outputStream includeMedia:NO];

                        msgProgress.completedUnitCount++;
                        if (progress) progress(msgProgress);
                    }

                    fromIndex += messages.count;

                    // å¦‚æœè¿”å›æ•°é‡å°äºæ‰¹æ¬¡å¤§å°ï¼Œè¯´æ˜å·²æ˜¯æœ€åä¸€æ‰¹
                    if (messages.count < batchSize) break;
                }
            }

            [self writeString:@"]" toStream:outputStream];  // messages ç»“æŸ
            [self writeString:@"}" toStream:outputStream];    // conversation ç»“æŸ

            if (i < conversations.count - 1) {
                [self writeString:@"," toStream:outputStream];
            }

            parentProgress.completedUnitCount++;
        }
    }

    [self writeString:@"]" toStream:outputStream];  // conversations ç»“æŸ

    // 3. å†™å…¥å°¾éƒ¨å’Œç»Ÿè®¡
    [self writeJSONFooter:outputStream];

    [outputStream close];
}

// è¾…åŠ©æ–¹æ³•ï¼šå†™å…¥ JSON é”®å€¼å¯¹
- (void)writeJSONKeyValue:(NSString *)key
                    value:(id)value
                 toStream:(NSOutputStream *)stream {
    if ([self needsComma]) {
        [self writeString:@"," toStream:stream];
    }

    [self writeString:[NSString stringWithFormat:@"\"%@\":", key] toStream:stream];

    if ([value isKindOfClass:[NSString class]]) {
        NSString *escaped = [self escapeJSONString:value];
        [self writeString:[NSString stringWithFormat:@"\"%@\"", escaped] toStream:stream];
    } else if ([value isKindOfClass:[NSNumber class]]) {
        NSString *jsonValue = [self numberToJSONString:value];
        [self writeString:jsonValue toStream:stream];
    } else if ([value isKindOfClass:[NSArray class]]) {
        // å¤„ç†æ•°ç»„
    } else if ([value isKindOfClass:[NSDictionary class]]) {
        // å¤„ç†å¯¹è±¡
    }
}

// å†™å…¥æ¶ˆæ¯ JSON
- (void)writeMessageJSON:(WFCCMessage *)message
               toStream:(NSOutputStream *)stream
           includeMedia:(BOOL)includeMedia {
    [self writeString:@"{" toStream:stream];

    [self writeJSONKeyValue:@"messageUid" value:@(message.messageUid) toStream:stream];
    [self writeJSONKeyValue:@"fromUser" value:message.fromUser toStream:stream];
    [self writeJSONKeyValue:@"toUsers" value:message.toUsers ?: @[] toStream:stream];
    [self writeJSONKeyValue:@"direction" value:@(message.direction) toStream:stream];
    [self writeJSONKeyValue:@"status" value:@(message.status) toStream:stream];
    [self writeJSONKeyValue:@"timestamp" value:@(message.serverTime) toStream:stream];
    [self writeJSONKeyValue:@"localExtra" value:message.localExtra ?: @"" toStream:stream];

    // å†™å…¥ payload
    [self writeString:@",\"payload\":{" toStream:stream];

    WFCCMessagePayload *payload = [message.content encode];
    [self writeJSONKeyValue:@"contentType" value:@(payload.contentType) toStream:stream];
    [self writeJSONKeyValue:@"searchableContent" value:payload.searchableContent ?: @"" toStream:stream];
    // ... å…¶ä»–å­—æ®µ

    // åª’ä½“æ¶ˆæ¯å¤„ç†
    if ([message.content isKindOfClass:[WFCCMediaMessageContent class]]) {
        WFCCMediaMessageContent *mediaContent = (WFCCMediaMessageContent *)message.content;
        [self writeJSONKeyValue:@"mediaType" value:@(mediaContent.mediaType) toStream:stream];
        [self writeJSONKeyValue:@"remoteMediaUrl" value:mediaContent.remoteMediaUrl ?: @"" toStream:stream];

        if (includeMedia && mediaContent.localMediaPath.length > 0) {
            [self writeJSONKeyValue:@"localMediaPath" value:mediaContent.localMediaPath toStream:stream];
        } else {
            [self writeJSONKeyValue:@"localMediaPath" value:@"" toStream:stream];
        }
    }

    [self writeString:@"}" toStream:stream];  // payload ç»“æŸ
    [self writeString:@"}" toStream:stream];  // message ç»“æŸ
}
```

#### ä¼˜åŠ¿
- âœ… **å†…å­˜å ç”¨ä½**ï¼šä»…éœ€ç¼“å­˜ä¸€ä¸ªæ‰¹æ¬¡çš„æ•°æ®ï¼ˆ~10-50MBï¼‰
- âœ… **æ”¯æŒå¤§æ•°æ®é‡**ï¼šç†è®ºä¸Šæ— ä¸Šé™
- âœ… **å¯éšæ—¶ä¸­æ–­**ï¼šåŸºäºæµçš„å¤„ç†å¯ä»¥æš‚åœ

---

### âŒ æ–¹æ¡ˆ 2ï¼šæ•°æ®åº“ç›´æ¥å¯¼å‡ºï¼ˆä¸å¯è¡Œï¼‰

<details>
<summary><b>æ­¤æ–¹æ¡ˆä¸å¯è¡Œ - ç‚¹å‡»å±•å¼€æŸ¥çœ‹åŸå› </b></summary>

**åŸå› **ï¼šè¿åæ¶æ„çº¦æŸï¼Œç¦æ­¢ç›´æ¥è®¿é—®æ•°æ®åº“ã€‚

#### ä¸ºä»€ä¹ˆä¸å¯è¡Œï¼Ÿ

1. **SDK å±‚çš„ä¸šåŠ¡é€»è¾‘è¢«ç»•è¿‡**
   - æ¶ˆæ¯çš„å…³è”å…³ç³»ä¸ä¼šå»ºç«‹
   - ç´¢å¼•ä¸ä¼šæ›´æ–°
   - é€šçŸ¥ä¸ä¼šè§¦å‘

2. **æ•°æ®ä¸€è‡´æ€§é£é™©**
   - å¯èƒ½ç ´åæ•°æ®åº“ç»“æ„
   - SDK å‡çº§åå¯èƒ½å¤±æ•ˆ

3. **å¤šç«¯åŒæ­¥é—®é¢˜**
   - ç›´æ¥å†™å…¥çš„æ•°æ®å¯èƒ½ä¸æœåŠ¡ç«¯ä¸åŒæ­¥
   - å¯èƒ½å¯¼è‡´æ¶ˆæ¯å†²çª

#### âŒ é”™è¯¯ç¤ºä¾‹

```objc
// âŒ ç¦æ­¢è¿™æ ·åš
sqlite3 *db;
sqlite3_open([dbPath UTF8String], &db);
sqlite3_exec(db, "SELECT * FROM messages", ...);  // ç¦æ­¢ï¼
```

</details>

---

### æ–¹æ¡ˆ 2ï¼šåˆ†æ–‡ä»¶å¤‡ä»½ï¼ˆæ¨èï¼‰

**æ ¸å¿ƒæ€è·¯**ï¼šå°†å¤‡ä»½æ‹†åˆ†æˆå¤šä¸ªå°æ–‡ä»¶

#### æ–‡ä»¶ç»“æ„

```
backup_user123_20250109/
â”œâ”€â”€ meta.json              # å…ƒæ•°æ®ï¼ˆä¼šè¯åˆ—è¡¨ã€ç»Ÿè®¡ï¼‰
â”œâ”€â”€ conversations/         # ä¼šè¯æ•°æ®ï¼ˆæ¯ä¸ªä¼šè¯ä¸€ä¸ªæ–‡ä»¶ï¼‰
â”‚   â”œâ”€â”€ single_user123.json
â”‚   â”œâ”€â”€ group_group456.json
â”‚   â””â”€â”€ ...
â””â”€â”€ media/                 # åª’ä½“æ–‡ä»¶
    â”œâ”€â”€ media_abc123.jpg
    â””â”€â”€ ...
```

#### å®ç°

```objc
- (void)createSplitBackup:(NSString *)basePath
                 progress:(void(^)(NSProgress *))progress
                  success:(void(^)(NSString *))success
                    error:(void(^)(int))error {

    // åˆ›å»ºç›®å½•ç»“æ„
    NSString *backupDir = basePath;
    NSString *conversationsDir = [backupDir stringByAppendingPathComponent:@"conversations"];
    NSString *mediaDir = [backupDir stringByAppendingPathComponent:@"media"];

    [[NSFileManager defaultManager] createDirectoryAtPath:conversationsDir
                              withIntermediateDirectories:YES
                                               attributes:nil
                                                    error:nil];
    [[NSFileManager defaultManager] createDirectoryAtPath:mediaDir
                              withIntermediateDirectories:YES
                                               attributes:nil
                                                    error:nil];

    // 1. åˆ›å»ºå…ƒæ•°æ®
    NSMutableArray *convMetaList = [NSMutableArray array];

    // 2. è·å–ä¼šè¯åˆ—è¡¨
    NSArray *conversations = [[WFCCIMService sharedWFCIMService] getConversationInfos:@[@1, @2] lines:@[@0]];

    NSProgress *parentProgress = [NSProgress progressWithTotalUnitCount:conversations.count];

    for (WFCCConversationInfo *convInfo in conversations) {
        @autoreleasepool {
            WFCCConversation *conversation = convInfo.conversation;

            // ä¸ºæ¯ä¸ªä¼šè¯åˆ›å»ºå•ç‹¬çš„æ–‡ä»¶
            NSString *convFilename = [NSString stringWithFormat:@"%@_%@.json",
                [self conversationTypeString:conversation.type],
                conversation.target];

            NSString *convFilePath = [conversationsDir stringByAppendingPathComponent:convFilename];

            // å¤‡ä»½å•ä¸ªä¼šè¯
            [self backupSingleConversation:convInfo
                                    toFile:convFilePath
                                 mediaDir:mediaDir
                                  progress:nil];

            // è®°å½•å…ƒæ•°æ®
            [convMetaList addObject:@{
                @"type": @(conversation.type),
                @"target": conversation.target,
                @"file": convFilename,
                @"messageCount": @([self getMessageCountForConversation:conversation])
            }];

            parentProgress.completedUnitCount++;
            if (progress) progress(parentProgress);
        }
    }

    // 3. ä¿å­˜å…ƒæ•°æ®
    NSDictionary *metaData = @{
        @"version": BackupVersion,
        @"backupTime": [[NSDate date] ISO8601String],
        @"userId": [[WFCCIMService sharedWFCIMService] currentUserId],
        @"conversations": convMetaList
    };

    NSString *metaPath = [backupDir stringByAppendingPathComponent:@"meta.json"];
    NSData *metaJSON = [NSJSONSerialization dataWithJSONObject:metaData
                                                       options:NSJSONWritingPrettyPrinted
                                                         error:nil];
    [metaJSON writeToFile:metaPath atomically:YES];

    success(backupDir);
}

// å¤‡ä»½å•ä¸ªä¼šè¯
- (void)backupSingleConversation:(WFCCConversationInfo *)convInfo
                         toFile:(NSString *)filePath
                      mediaDir:(NSString *)mediaDir
                       progress:(void(^)(NSProgress *))progress {

    WFCCConversation *conversation = convInfo.conversation;

    // åˆ›å»ºè¾“å‡ºæµ
    NSOutputStream *outputStream = [NSOutputStream outputStreamToFileAtPath:filePath append:NO];
    [outputStream open];

    // å†™å…¥ä¼šè¯ä¿¡æ¯
    [self writeString:@"{" toStream:outputStream];
    [self writeJSONKeyValue:@"type" value:@(conversation.type) toStream:outputStream];
    [self writeJSONKeyValue:@"target" value:conversation.target toStream:outputStream];
    [self writeJSONKeyValue:@"line" value:@(conversation.line) toStream:outputStream];
    [self writeJSONKeyValue:@"isTop" value:@(convInfo.isTop) toStream:outputStream];
    [self writeJSONKeyValue:@"isSilent" value:@(convInfo.isSilent) toStream:outputStream];
    [self writeJSONKeyValue:@"draft" value:convInfo.draft ?: @"" toStream:outputStream];

    // å†™å…¥æ¶ˆæ¯
    [self writeString:@"\"messages\":[" toStream:outputStream];

    // åˆ†æ‰¹è·å–
    NSInteger fromIndex = 0;
    NSInteger batchSize = 100;
    BOOL isFirstMsg = YES;

    while (YES) {
        @autoreleasepool {
            NSArray *messages = [[WFCCIMService sharedWFCIMService] getMessages:conversation
                                                                contentTypes:nil
                                                                        from:fromIndex
                                                                       count:batchSize
                                                                    withUser:nil];
            if (messages.count == 0) break;

            for (WFCCMessage *msg in messages) {
                if (!isFirstMsg) {
                    [self writeString:@"," toStream:outputStream];
                }
                isFirstMsg = NO;

                [self writeMessageJSON:msg toStream:outputStream includeMedia:YES];
            }

            fromIndex += messages.count;
            if (messages.count < batchSize) break;
        }
    }

    [self writeString:@"]}" toStream:outputStream];
    [outputStream close];
}
```

#### ä¼˜åŠ¿
- âœ… **æ˜“äºæ¢å¤å•ä¸ªä¼šè¯**ï¼šå¯ä»¥é€‰æ‹©æ€§æ¢å¤
- âœ… **æ”¯æŒå¹¶è¡Œå¤‡ä»½**ï¼šå¯ä»¥å¹¶å‘å¤„ç†å¤šä¸ªä¼šè¯
- âœ… **æ˜“äºæŸ¥çœ‹**ï¼šæ¯ä¸ªæ–‡ä»¶éƒ½æ˜¯ç‹¬ç«‹å®Œæ•´çš„
- âœ… **æ”¯æŒå¢é‡æ›´æ–°**ï¼šåªä¿®æ”¹å˜æ›´çš„ä¼šè¯æ–‡ä»¶

---

### æ–¹æ¡ˆ 4ï¼šä½¿ç”¨å‹ç¼©

**æ ¸å¿ƒæ€è·¯**ï¼šå‹ç¼©å¤‡ä»½æ–‡ä»¶ä»¥å‡å°‘å­˜å‚¨ç©ºé—´å’Œä¼ è¾“æ—¶é—´

#### å®ç°

```objc
- (void)createCompressedBackup:(NSString *)filePath
                      progress:(void(^)(NSProgress *))progress
                       success:(void(^)(NSString *))success
                         error:(void(^)(int))error {

    // 1. å…ˆåˆ›å»ºæœªå‹ç¼©å¤‡ä»½
    NSString *tempFile = [filePath stringByAppendingPathExtension:@"tmp"];

    [self createFullBackup:tempFile
           mediaStructure:@"flat"
                 progress:progress
                  success:^(NSString *backupPath) {

        // 2. å‹ç¼©å¤‡ä»½æ–‡ä»¶
        [self compressFile:backupPath
                   toFile:filePath
                 progress:progress
                  success:^{
            // åˆ é™¤ä¸´æ—¶æ–‡ä»¶
            [[NSFileManager defaultManager] removeItemAtPath:backupPath error:nil];
            success(filePath);
        } error:^(int errorCode) {
            error(error);
        }];

    } error:error];
}

// å‹ç¼©æ–‡ä»¶
- (void)compressFile:(NSString *)inputPath
              toFile:(NSString *)outputPath
            progress:(void(^)(NSProgress *))progress
             success:(void(^)(void))success
               error:(void(^)(int))error {

    // ä½¿ç”¨ Zlib å‹ç¼©
    NSOutputStream *outputStream = [NSOutputStream outputStreamToFileAtPath:outputPath append:NO];
    [outputStream open];

    NSInputStream *inputStream = [NSInputStream inputStreamWithFileAtPath:inputPath];
    [inputStream open];

    // è®¾ç½®å‹ç¼©çº§åˆ«
   [zlib setupCompression:outputStream level:Z_DEFAULT_COMPRESSION];

    NSProgress *compressProgress = [NSProgress progressWithTotalUnitCount:100];
    NSInteger fileSize = [[NSFileManager defaultManager] attributesOfItemAtPath:inputPath error:nil].fileSize;
    NSInteger processedBytes = 0;

    uint8_t buffer[32768];  // 32KB ç¼“å†²åŒº
    NSInteger bytesRead;

    while ((bytesRead = [inputStream read:buffer maxLength:sizeof(buffer)]) > 0) {
        // å‹ç¼©å¹¶å†™å…¥
        [outputStream write:buffer maxLength:bytesRead];

        processedBytes += bytesRead;
        compressProgress.completedUnitCount = (processedBytes * 100 / fileSize);

        if (progress) {
            progress(compressProgress);
        }
    }

    [inputStream close];
    [outputStream close];

    success();
}
```

#### å‹ç¼©æ•ˆæœå¯¹æ¯”

| å†…å®¹ç±»å‹ | åŸå§‹å¤§å° | GZip å‹ç¼© | å‹ç¼©ç‡ |
|---------|---------|----------|--------|
| ä»…æ–‡æœ¬æ¶ˆæ¯ | 10MB | 2MB | 80% |
| å«å›¾ç‰‡ | 100MB | 95MB | 5% |
| æ··åˆå†…å®¹ | 50MB | 30MB | 40% |

---

### æ–¹æ¡ˆ 5ï¼šå¢é‡å¤‡ä»½ + åˆå¹¶

**æ ¸å¿ƒæ€è·¯**ï¼šåªå¤‡ä»½å˜åŒ–çš„æ•°æ®ï¼Œå®šæœŸåˆå¹¶

#### è®¾è®¡

```objc
// ç¬¬ä¸€æ¬¡å…¨é‡å¤‡ä»½
backup_full_20250109.json

// åç»­å¢é‡å¤‡ä»½
backup_inc_20250110.json  // ç›¸å¯¹äº 20250109 çš„å˜åŒ–
backup_inc_20250111.json  // ç›¸å¯¹äº 20250110 çš„å˜åŒ–

// å®šæœŸåˆå¹¶ï¼ˆå¦‚æ¯å‘¨ï¼‰
backup_full_20250115.json  // åˆå¹¶åçš„å…¨é‡å¤‡ä»½
```

#### å®ç°

```objc
- (void)createIncrementalBackup:(NSString *)filePath
                 basedOnBackup:(NSString *)baseBackupPath
                      progress:(void(^)(NSProgress *))progress
                       success:(void(^)(NSString *))success
                         error:(void(^)(int))error {

    // 1. è¯»å–åŸºç¡€å¤‡ä»½ä¿¡æ¯
    NSDictionary *baseBackup = [self readBackupFile:baseBackupPath];
    long long lastBackupTime = [baseBackup[@"backupTime"] longLongValue];

    // 2. åˆ›å»ºå¢é‡å¤‡ä»½
    NSMutableDictionary *incBackup = [NSMutableDictionary dictionary];
    incBackup[@"version"] = BackupVersion;
    incBackup[@"type"] = @"incremental";
    incBackup[@"baseBackupId"] = [self getBackupId:baseBackupPath];
    incBackup[@"backupTime"] = @([[NSDate date] timeIntervalSince1970]);
    incBackup[@"timeRange"] = @{
        @"start": @(lastBackupTime),
        @"end": @([[NSDate date] timeIntervalSince1970])
    };

    NSMutableArray *incConversations = [NSMutableArray array];

    // 3. è·å–åŸºç¡€å¤‡ä»½ä¸­çš„æ‰€æœ‰ä¼šè¯
    NSDictionary *baseConvsMap = [self buildConversationMap:baseBackup[@"conversations"]];

    // 4. è·å–å½“å‰ä¼šè¯åˆ—è¡¨
    NSArray *currentConvs = [[WFCCIMService sharedWFCIMService] getConversationInfos:@[@1, @2] lines:@[@0]];

    for (WFCCConversationInfo *convInfo in currentConvs) {
        NSString *convKey = [NSString stringWithFormat:@"%d_%@", convInfo.conversation.type, convInfo.conversation.target];

        NSDictionary *baseConv = baseConvsMap[convKey];
        long long lastMessageUid = baseConv ? [baseConv[@"lastMessageUid"] longLongValue] : 0;

        // æŸ¥è¯¢æ–°å¢çš„æ¶ˆæ¯
        NSArray *newMessages = [self getMessagesAfter:conversation messageUid:lastMessageUid];

        if (newMessages.count > 0 || [self isConversationModified:convInfo comparedTo:baseConv]) {
            // è®°å½•å˜åŒ–
            [incConversations addObject:@{
                @"conversation": @{
                    @"type": @(convInfo.conversation.type),
                    @"target": convInfo.conversation.target,
                    @"line": @(convInfo.conversation.line)
                },
                @"newMessages": [self encodeMessages:newMessages],
                @"modifiedSettings": [self getModifiedSettings:convInfo comparedTo:baseConv]
            }];
        }
    }

    // 5. æŸ¥æ‰¾å·²åˆ é™¤çš„ä¼šè¯
    NSArray *deletedConvs = [self findDeletedConversations:baseBackup[@"conversations"]
                                          currentConversations:currentConvs];
    if (deletedConvs.count > 0) {
        [incConversations addObject:@{
            @"deletedConversations": deletedConvs
        }];
    }

    incBackup[@"conversations"] = incConversations;

    // 6. ä¿å­˜å¢é‡å¤‡ä»½
    NSData *jsonData = [NSJSONSerialization dataWithJSONObject:incBackup
                                                       options:NSJSONWritingPrettyPrinted
                                                         error:nil];
    [jsonData writeToFile:filePath atomically:YES];

    success(filePath);
}
```

---

## æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | å†…å­˜å ç”¨ | é€Ÿåº¦ | å¤æ‚åº¦ | å¯æš‚åœæ€§ | é€‚ç”¨åœºæ™¯ |
|------|---------|------|--------|---------|---------|
| åŸå§‹æ–¹æ¡ˆ | é«˜ | æ…¢ | ä½ | âŒ | < 1ä¸‡æ¡æ¶ˆæ¯ |
| æµå¼JSON | ä½ | ä¸­ | ä¸­ | âœ… | é€šç”¨æ¨è â­ |
| ~~æ•°æ®åº“å¯¼å‡º~~ | ~~æœ€ä½~~ | ~~å¿«~~ | ~~é«˜~~ | âœ… | âŒ ä¸å¯è¡Œ |
| åˆ†æ–‡ä»¶å¤‡ä»½ | ä½ | ä¸­ | ä¸­ | âœ… | éœ€è¦é€‰æ‹©æ€§æ¢å¤ |
| å‹ç¼© | ä½ | æ…¢ | ä½ | âœ… | å­˜å‚¨ç©ºé—´å—é™ |
| å¢é‡å¤‡ä»½ | ä½ | å¿« | é«˜ | âœ… | å®šæœŸå¤‡ä»½ |

---

## æ¨èæ–¹æ¡ˆç»„åˆ

### åœºæ™¯ 1ï¼šé€šç”¨åœºæ™¯ï¼ˆæ¨èï¼‰â­
**æµå¼ JSON + åˆ†æ‰¹å¤„ç†**
- å†…å­˜å ç”¨ï¼š~50MB
- é€Ÿåº¦ï¼šä¸­ç­‰
- å¯æ‰©å±•æ€§å¥½
- ç¬¦åˆ SDK æ¶æ„çº¦æŸ

### åœºæ™¯ 2ï¼šé€‰æ‹©æ€§æ¢å¤éœ€æ±‚
**åˆ†æ–‡ä»¶å¤‡ä»½ + æµå¼JSON**
- å¯ä»¥åªæ¢å¤æŸä¸ªä¼šè¯
- æ”¯æŒå¹¶è¡Œå¤„ç†

### åœºæ™¯ 3ï¼šå­˜å‚¨ç©ºé—´å—é™
**æµå¼ JSON + GZip å‹ç¼©**
- å‡å°‘æ–‡ä»¶å¤§å° 40-80%
- é€‚åˆäº‘å­˜å‚¨å¤‡ä»½

---

## å®ç°ä¼˜å…ˆçº§

1. âœ… **Phase 1**ï¼šå®ç°æµå¼ JSON å†™å…¥ + åˆ†æ‰¹å¤„ç†ï¼ˆæ ¸å¿ƒä¼˜åŒ–ï¼‰
2. ğŸ”¥ **Phase 1.5**ï¼šä½¿ç”¨äº‹åŠ¡åŠ é€Ÿæ‰¹é‡å†™å…¥ï¼ˆæ¢å¤æ€§èƒ½æå‡ 10-20 å€ï¼‰
3. âœ… **Phase 2**ï¼šæ·»åŠ å‹ç¼©æ”¯æŒï¼ˆæå‡ç”¨æˆ·ä½“éªŒï¼‰
4. âœ… **Phase 3**ï¼šå®ç°å¢é‡å¤‡ä»½ï¼ˆé«˜çº§åŠŸèƒ½ï¼‰
5. âšª **Phase 4**ï¼šå¹¶è¡Œå¤„ç†ï¼ˆè¿›ä¸€æ­¥ä¼˜åŒ–ï¼‰

---

## æ€§èƒ½ä¼˜åŒ–æŠ€å·§æ€»ç»“

### 0. äº‹åŠ¡ä¼˜åŒ–ï¼ˆæœ€æœ‰æ•ˆçš„ä¼˜åŒ–ï¼‰â­â­â­

å¯¹äºæ¢å¤å¤§é‡æ¶ˆæ¯ï¼Œä½¿ç”¨äº‹åŠ¡æ˜¯æœ€æœ‰æ•ˆçš„ä¼˜åŒ–æ‰‹æ®µã€‚

```objc
// âœ… ä½¿ç”¨äº‹åŠ¡æ‰¹é‡å†™å…¥ï¼ˆæ¨èï¼‰
if (totalMessages > 100) {
    [[WFCCIMService sharedWFCIMService] beginTransaction];

    @try {
        // æ‰¹é‡æ’å…¥æ¶ˆæ¯
        for (NSDictionary *msgDict in messages) {
            [[WFCCIMService sharedWFCIMService] insertMessage:...];
        }

        // æäº¤äº‹åŠ¡
        [[WFCCIMService sharedWFCIMService] commitTransaction];
    } @catch (NSException *exception) {
        // å¼‚å¸¸æ—¶å›æ»š
        [[WFCCIMService sharedWFCIMService] rollbackTransaction];
    }
}

// âŒ ä¸ä½¿ç”¨äº‹åŠ¡ï¼ˆæ€§èƒ½å·®ï¼‰
for (NSDictionary *msgDict in messages) {
    [[WFCCIMService sharedWFCIMService] insertMessage:...];
    // æ¯æ¬¡éƒ½ä¼šè§¦å‘ç£ç›˜ I/O
}
```

**æ€§èƒ½æå‡**ï¼š
- 1,000 æ¡æ¶ˆæ¯ï¼š**10 å€**ï¼ˆ30ç§’ â†’ 3ç§’ï¼‰
- 10,000 æ¡æ¶ˆæ¯ï¼š**15 å€**ï¼ˆ5åˆ†é’Ÿ â†’ 20ç§’ï¼‰
- 100,000 æ¡æ¶ˆæ¯ï¼š**20 å€**ï¼ˆ60åˆ†é’Ÿ â†’ 3åˆ†é’Ÿï¼‰

**ä½¿ç”¨æ—¶æœº**ï¼š
- æ¶ˆæ¯æ•°é‡ > 100 æ—¶ä½¿ç”¨
- æ¶ˆæ¯æ•°é‡ < 10 æ—¶ä¸ä½¿ç”¨ï¼ˆæ— æ€§èƒ½æå‡ï¼‰

**æ³¨æ„äº‹é¡¹**ï¼š
- å¿…é¡»ä½¿ç”¨ `@try-@catch` ç¡®ä¿å¼‚å¸¸æ—¶å›æ»š
- ä¸è¦åµŒå¥—äº‹åŠ¡ï¼ˆä¼šå¯¼è‡´æ­»é”ï¼‰
- äº‹åŠ¡æœŸé—´æ•°æ®åœ¨å†…å­˜ä¸­ï¼Œæ³¨æ„å†…å­˜é™åˆ¶

---

### 1. å†…å­˜ä¼˜åŒ–
```objc
// âœ… ä½¿ç”¨ @autoreleasepool
for (WFCCConversationInfo *convInfo in conversations) {
    @autoreleasepool {
        // å¤„ç†é€»è¾‘
    }
}

// âœ… åˆ†æ‰¹å¤„ç†
NSInteger batchSize = 100;
while (YES) {
    NSArray *batch = [self getBatch:fromIndex count:batchSize];
    if (batch.count == 0) break;
    fromIndex += batch.count;
}

// âœ… åŠæ—¶é‡Šæ”¾
NSMutableArray *messages;  // ç”¨å®Œå³é‡Šæ”¾
messages = nil;
```

### 2. IO ä¼˜åŒ–
```objc
// âœ… ä½¿ç”¨æµå¼å†™å…¥
NSOutputStream *outputStream = [NSOutputStream outputStreamToFileAtPath:path append:NO];
[outputStream open];
[outputStream write:buffer maxLength:length];
[outputStream close];

// âŒ é¿å…ä¸€æ¬¡æ€§å†™å…¥
NSData *bigData;  // å¯èƒ½å‡ ç™¾MB
[bigData writeToFile:path atomically:YES];  // å†…å­˜å³°å€¼
```

### 3. å¹¶å‘ä¼˜åŒ–
```objc
// âœ… å¹¶è¡Œå¤„ç†å¤šä¸ªä¼šè¯
dispatch_queue_t queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);
dispatch_apply(conversations.count, queue, ^(size_t index) {
    WFCCConversationInfo *convInfo = conversations[index];
    [self backupConversation:convInfo];
});
```

### 4. è¿›åº¦ä¼˜åŒ–
```objc
// âœ… é™åˆ¶å›è°ƒé¢‘ç‡
- (void)notifyProgress:(NSProgress *)progress {
    static NSTimeInterval lastTime = 0;
    NSTimeInterval now = [[NSDate date] timeIntervalSince1970];

    if (now - lastTime >= 0.1 || progress.isFinished) {  // æœ€å¤šæ¯ 0.1 ç§’å›è°ƒä¸€æ¬¡
        if (self.progressCallback) {
            dispatch_async(dispatch_get_main_queue(), ^{
                self.progressCallback(progress);
            });
        }
        lastTime = now;
    }
}
```

---

## æµ‹è¯•æ–¹æ¡ˆ

### å¤§æ•°æ®é‡æµ‹è¯•

```objc
// å‡†å¤‡æµ‹è¯•æ•°æ®
- (void)prepareLargeDataset {
    // åˆ›å»º 100 ä¸ªä¼šè¯
    for (int i = 0; i < 100; i++) {
        // æ¯ä¸ªä¼šè¯ 10000 æ¡æ¶ˆæ¯
        for (int j = 0; j < 10000; j++) {
            [self insertTestMessage];
        }
    }
    // æ€»å…± 100 ä¸‡æ¡æ¶ˆæ¯
}

// æ€§èƒ½æµ‹è¯•
- (void)testPerformance {
    [self measureMetrics:@[XCTMemoryMetric, XCTCPUMetric, XCTTimeMetric] forBlock:^{
        [self.backupManager createMessageOnlyBackup:@"/tmp/large_backup.json"
                                            progress:nil
                                             success:nil
                                               error:^(int errorCode) {
            XCTAssertNotNil(error);
        }];
    }];
}
```

---

## æ–¹æ¡ˆ 6ï¼šJSON å­—æ®µä¼˜åŒ–ï¼ˆå·²å®ç°ï¼‰âœ…

**æ ¸å¿ƒæ€è·¯**ï¼šè·³è¿‡ç©ºå­—æ®µï¼Œå‡å°‘å¤‡ä»½æ–‡ä»¶å¤§å°

### å®ç°æ–¹å¼

åœ¨ç¼–ç æ¶ˆæ¯å’Œä¼šè¯ä¿¡æ¯æ—¶ï¼Œè‡ªåŠ¨è·³è¿‡ç©ºå­—ç¬¦ä¸²å’Œç©ºæ•°ç»„ï¼š

```objc
// å®‰å…¨åœ°æ·»åŠ å­—ç¬¦ä¸²å€¼ï¼ˆè·³è¿‡ç©ºå­—ç¬¦ä¸²ï¼‰
- (void)safelySetString:(NSString *)string forKey:(NSString *)key inDictionary:(NSMutableDictionary *)dict {
    if (string && string.length > 0) {
        dict[key] = string;
    }
}

// å®‰å…¨åœ°æ·»åŠ æ•°ç»„å€¼ï¼ˆè·³è¿‡ç©ºæ•°ç»„ï¼‰
- (void)safelySetArray:(NSArray *)array forKey:(NSString *)key inDictionary:(NSMutableDictionary *)dict {
    if (array && array.count > 0) {
        dict[key] = array;
    }
}
```

### åº”ç”¨èŒƒå›´

è·³è¿‡ä»¥ä¸‹ç©ºå­—æ®µï¼š
- `fromUser`ã€`toUsers` - å‘é€è€…ä¿¡æ¯
- `localExtra` - æœ¬åœ°æ‰©å±•
- `searchableContent`ã€`pushContent`ã€`pushData` - æœç´¢å’Œæ¨é€å†…å®¹
- `content`ã€`binaryContent`ã€`localContent` - æ¶ˆæ¯å†…å®¹
- `mentionedTargets` - @æåŠç›®æ ‡
- `extra` - æ‰©å±•å­—æ®µ
- `remoteMediaUrl` - è¿œç¨‹åª’ä½“ URL
- `draft` - ä¼šè¯è‰ç¨¿

### æ€§èƒ½æå‡

| åœºæ™¯ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| çº¯æ–‡æœ¬ä¼šè¯ | 100% | 70-80% | 20-30% |
| å›¾ç‰‡æ¶ˆæ¯ä¼šè¯ | 100% | 85-90% | 10-15% |
| æ··åˆæ¶ˆæ¯ä¼šè¯ | 100% | 75-85% | 15-25% |

å¹³å‡å‡å°‘ **15-25%** çš„å¤‡ä»½æ–‡ä»¶å¤§å°ã€‚

### ä¼˜åŠ¿

- âœ… **å‡å°æ–‡ä»¶ä½“ç§¯**ï¼šèŠ‚çœå­˜å‚¨ç©ºé—´
- âœ… **åŠ å¿«åºåˆ—åŒ–é€Ÿåº¦**ï¼šå‡å°‘éœ€è¦å¤„ç†çš„æ•°æ®é‡
- âœ… **åŠ å¿«ä¼ è¾“é€Ÿåº¦**ï¼šç½‘ç»œå¤‡ä»½/æ¢å¤æ›´å¿«
- âœ… **é™ä½å†…å­˜å ç”¨**ï¼šå¤„ç†çš„æ•°æ®æ›´å°‘
- âœ… **è‡ªåŠ¨ä¼˜åŒ–**ï¼šæ— éœ€ç”¨æˆ·é…ç½®

### æ³¨æ„äº‹é¡¹

- ç©ºå­—ç¬¦ä¸² `""` å’Œ `nil` éƒ½ä¼šè¢«è·³è¿‡
- æ•°ç»„ä¸ºç©º `[]` æ—¶ä¼šè¢«è·³è¿‡
- æ•°å­—å­—æ®µï¼ˆå¦‚ `0`ï¼‰ä¸ä¼šè¢«è·³è¿‡ï¼ˆä¿æŒæ˜ç¡®çš„è¯­ä¹‰ï¼‰
- å¸ƒå°”å­—æ®µä¸ä¼šè¢«è·³è¿‡ï¼ˆä¿æŒæ˜ç¡®çš„è¯­ä¹‰ï¼‰

---

## æ€»ç»“

é’ˆå¯¹å¤§æ•°æ®é‡çš„æ€§èƒ½é—®é¢˜ï¼Œæ¨èé‡‡ç”¨**æµå¼ JSON å†™å…¥**ä½œä¸ºåŸºç¡€æ–¹æ¡ˆï¼Œå¹¶ç»“åˆä»¥ä¸‹ä¼˜åŒ–ï¼š

1. âœ… **æµå¼å¤„ç†** - é™ä½å†…å­˜å ç”¨
2. âœ… **åˆ†æ‰¹åŠ è½½** - é¿å…ä¸€æ¬¡æ€§åŠ è½½
3. âœ… **å¼‚æ­¥æ‰§è¡Œ** - ä¸é˜»å¡ä¸»çº¿ç¨‹
4. âœ… **å‹ç¼©è¾“å‡º** - å‡å°‘å­˜å‚¨ç©ºé—´
5. âœ… **å¢é‡å¤‡ä»½** - æå‡å¤‡ä»½é€Ÿåº¦
6. âœ… **JSON å­—æ®µä¼˜åŒ–** - è·³è¿‡ç©ºå­—æ®µï¼ˆå·²å®ç°ï¼‰

è¿™æ ·å¯ä»¥æ”¯æŒç™¾ä¸‡çº§æ¶ˆæ¯çš„å¤‡ä»½æ¢å¤ï¼ŒåŒæ—¶ä¿æŒè‰¯å¥½çš„ç”¨æˆ·ä½“éªŒã€‚

