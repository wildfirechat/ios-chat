# 消息备份恢复功能实现总结

## 实现概述

已完成基于目录结构的消息备份恢复功能，支持加密备份、选择性会话备份、媒体文件备份，以及自动清理不完整备份等特性。

## 核心文件

### 1. 备份管理器

**文件**：
- `wfclient/WFChatClient/Backup/WFCCMessageBackupManager.h` - 头文件
- `wfclient/WFChatClient/Backup/WFCCMessageBackupManager.m` - 实现文件

**主要功能**：
- ✅ 创建目录结构备份 (`createDirectoryBasedBackup`)
- ✅ 从目录备份恢复 (`restoreFromBackup`)
- ✅ 获取目录备份信息 (`getDirectoryBackupInfo`)
- ✅ 取消当前操作 (`cancelCurrentOperation`)
- ✅ 清理不完整备份 (`cleanupIncompleteBackup`)

**核心特性**：

1. **目录结构格式**
   - 每个会话独立存储在单独的目录
   - 只加密 messages.json 文件
   - 媒体文件明文存储，便于查看

2. **选择性备份**
   - 支持传入选中的会话列表进行备份
   - 未传入会话时自动备份所有会话

3. **加密支持**
   - 使用 AES-256-CBC 加密
   - PBKDF2-SHA256 密钥派生
   - 可选密码加密 messages.json

4. **进度反馈**
   - 实时报告备份/恢复进度
   - 返回消息数、媒体数、媒体总大小

5. **取消清理**
   - 取消备份时自动清理不完整的备份目录
   - 线程安全的取消标志
   - 递归删除整个备份文件夹

### 2. 加密工具类

**文件**：
- `wfclient/WFChatClient/Backup/WFCCBackupCrypto.h` - 头文件
- `wfclient/WFChatClient/Backup/WFCCBackupCrypto.m` - 实现文件

**主要功能**：
- ✅ 密钥派生（PBKDF2-SHA256）
- ✅ 数据加密（AES-256-CBC）
- ✅ 数据解密
- ✅ 文件 MD5 计算
- ✅ 密码提示支持

## 备份格式

### 目录结构

```
backup_2025-01-09_14-30-45/              # 备份文件夹（时间戳命名）
├── metadata.json                         # 元数据文件（不加密）
└── conversations/                        # 会话子目录
    ├── conv_type1_userA_line0/          # 单个会话目录
    │   ├── messages.json                # 加密消息文件
    │   └── media/                       # 媒体文件目录（不加密）
    │       ├── {md5前16位}.jpg
    │       └── {md5前16位}.mp4
    ├── conv_type2_groupB_line0/
    │   ├── messages.json
    │   └── media/
    └── ...
```

### metadata.json 结构

```json
{
  "version": "1",
  "format": "directory",
  "backupTime": "2025-01-09T14:30:45Z",
  "userId": "user123",
  "appType": "ios-chat",
  "backupMode": "message_with_media",
  "encryption": {
    "enabled": true,
    "algorithm": "AES-256-CBC",
    "keyDerivation": "PBKDF2-SHA256",
    "passwordHint": "密码提示"
  },
  "statistics": {
    "totalConversations": 15,
    "totalMessages": 3250,
    "mediaFileCount": 48,
    "mediaTotalSize": 52428800,
    "timeRange": {
      "firstMessageTime": 1704800000000,
      "lastMessageTime": 1704809445000
    }
  },
  "conversations": [
    {
      "conversationId": "conv_type1_userA_line0",
      "type": 1,
      "target": "userA",
      "line": 0,
      "messageCount": 120,
      "mediaCount": 5,
      "directory": "conv_type1_userA_line0"
    }
  ]
}
```

### messages.json 结构（加密）

```json
{
  "version": "1",
  "conversation": {
    "type": 1,
    "target": "userA",
    "line": 0
  },
  "settings": {
    "isTop": 0,
    "isSilent": false,
    "draft": "草稿内容"
  },
  "messages": [
    {
      "messageUid": 1704800000000001,
      "fromUser": "userA",
      "toUsers": ["userB"],
      "direction": 0,
      "status": 0,
      "timestamp": 1704800000000,
      "payload": {
        "contentType": 1,
        "searchableContent": "消息内容",
        "binaryContent": "base64编码数据",
        "localMediaInfo": {
          "relativePath": "media/abc123.jpg",
          "fileId": "abc123def456",
          "fileSize": 102400,
          "md5": "hash值"
        }
      }
    }
  ]
}
```

## 核心实现

### 备份流程

```
1. 创建备份根目录和 conversations 子目录
2. 获取要备份的会话列表（传入或全部）
3. 遍历每个会话：
   a. 创建会话目录和 media 子目录
   b. 获取该会话的所有消息（分批获取）
   c. 编码每条消息：
      - 提取消息基本信息
      - 编码 MessagePayload
      - 处理缩略图（图片消息）
      - 复制媒体文件到 media/ 目录
      - 记录媒体文件信息（MD5、大小）
   d. 保存 messages.json
   e. 如果提供密码，加密 messages.json
4. 创建 metadata.json
5. 清空备份路径标志（表示成功）
```

### 恢复流程

```
1. 读取 metadata.json
2. 验证备份信息
3. 遍历会话列表：
   a. 读取会话的 messages.json
   b. 如果加密，先解密
   c. 解析 JSON
   d. 恢复消息：
      - 检查消息是否已存在
      - 解码 MessagePayload
      - 恢复媒体文件路径
      - 复制媒体文件到 app 的 sendbox 目录
      - 插入消息到数据库（通过 SDK）
4. 返回恢复统计
```

### 取消和清理

```
1. 用户点击取消
2. 设置 isCancelled = YES（线程安全）
3. 备份循环检测到取消标志
4. 调用 cleanupIncompleteBackup
5. 递归删除整个备份目录
6. 返回 BackupError_Cancelled
```

## 性能优化

### 内存管理

- 使用 `@autoreleasepool` 包裹循环体
- 分批处理消息（每批100条）
- 及时释放大块数据

### 缩略图处理

- 检查 binaryContent 是否为空
- 如果为空，手动提取 thumbnail 并转换为 JPEG
- 压缩质量：0.45

### 媒体文件处理

- 使用 MD5 前16位命名文件，避免重复
- 只在确实复制了文件时统计媒体数量
- 计算并记录媒体文件总大小

### 线程安全

- `isCancelled` 使用 atomic 属性
- `currentBackupDirectory` 跟踪备份路径
- 所有回调在主线程执行

## 关键代码片段

### 缩略图保存

```objc
// 处理图片消息的缩略图
if ([message.content isKindOfClass:NSClassFromString(@"WFCCImageMessageContent")]) {
    if (!payload.binaryContent || payload.binaryContent.length == 0) {
        if ([message.content respondsToSelector:@selector(thumbnail)]) {
            UIImage *thumbnailImage = [(id)message.content thumbnail];
            if (thumbnailImage) {
                payload.binaryContent = UIImageJPEGRepresentation(thumbnailImage, 0.45);
                if (payload.binaryContent && payload.binaryContent.length > 0) {
                    payloadDict[@"binaryContent"] = [payload.binaryContent base64EncodedStringWithOptions:0];
                }
            }
        }
    }
}
```

### 媒体文件统计

```objc
// 只有在确实备份了媒体文件时才统计
if (msgDict[@"payload"][@"localMediaInfo"]) {
    convMediaCount++;
    totalMediaSize += [msgDict[@"mediaFileSize"] longLongValue];
}
```

### 清理不完整备份

```objc
- (void)cleanupIncompleteBackup {
    if (self.currentBackupDirectory && self.currentBackupDirectory.length > 0) {
        NSFileManager *fileManager = [NSFileManager defaultManager];
        BOOL isDirectory;
        if ([fileManager fileExistsAtPath:self.currentBackupDirectory isDirectory:&isDirectory] && isDirectory) {
            NSError *error;
            BOOL removed = [fileManager removeItemAtPath:self.currentBackupDirectory error:&error];
            if (removed) {
                NSLog(@"[WFCCMessageBackupManager] Cleaned up incomplete backup: %@", self.currentBackupDirectory);
            } else {
                NSLog(@"[WFCCMessageBackupManager] Failed to cleanup backup directory: %@, error: %@", self.currentBackupDirectory, error.localizedDescription);
            }
        }
        self.currentBackupDirectory = nil;
    }
}
```

## UI 组件

### 已实现的界面

1. **WFCConversationSelectViewController** - 会话选择界面
   - 支持单选/多选/全选
   - 使用 UITableView 的内置多选机制
   - 显示会话信息和消息数量

2. **WFCBackupOptionsViewController** - 备份选项界面
   - 选择是否包含媒体文件
   - 显示已选择的会话列表

3. **WFCBackupProgressViewController** - 备份进度界面
   - 显示备份/恢复进度
   - 支持取消操作
   - 显示完成统计（消息数、媒体数、媒体大小）

4. **WFCBackupListViewController** - 备份列表界面
   - 显示所有备份
   - 显示备份信息（时间、会话数、消息数、媒体信息）
   - 支持删除备份

5. **WFCRestoreOptionsViewController** - 恢复选项界面
   - 选择是否覆盖已存在的消息
   - 显示备份信息（时间、会话数、消息数、媒体信息）

## 错误处理

### 错误码定义

```objc
typedef NS_ENUM(NSInteger, BackupError) {
    BackupError_NoError = 0,
    BackupError_FileNotFound = 1001,
    BackupError_InvalidFormat = 1002,
    BackupError_IOError = 1003,
    BackupError_OutOfSpace = 1004,
    BackupError_Cancelled = 1005,
    BackupError_EncryptionFailed = 3001,
    BackupError_DecryptionFailed = 3002,
    BackupError_WrongPassword = 3003,
    BackupError_InvalidPassword = 3004,
    BackupError_NotEncrypted = 3006,
    BackupError_RestoreFailed = 4001
};
```

### 常量定义

```objc
static NSString * const kBackupVersion = @"1";
static NSString * const kBackupFormat = @"directory";
static NSString * const kBackupAppType = @"ios-chat";
static NSString * const kBackupModeMessageWithMedia = @"message_with_media";
static NSString * const kBackupEncryptionAlgorithm = @"AES-256-CBC";
static NSString * const kBackupKeyDerivation = @"PBKDF2-SHA256";
static const NSInteger kDefaultMessageBatchSize = -100;
static const CGFloat kThumbnailCompressionQuality = 0.45;
```

## 测试建议

### 功能测试

1. **基础备份**
   - 备份单个会话
   - 备份多个会话
   - 备份所有会话
   - 验证生成的文件结构

2. **媒体文件处理**
   - 备份包含媒体文件的会话
   - 验证媒体文件正确复制
   - 验证缩略图正确保存
   - 检查媒体统计信息

3. **加密备份**
   - 创建加密备份
   - 验证 messages.json 已加密
   - 验证 metadata.json 未加密
   - 使用正确密码恢复
   - 使用错误密码恢复

4. **取消操作**
   - 备份过程中取消
   - 验证不完整的备份目录被删除
   - 验证备份列表不显示不完整备份

5. **恢复功能**
   - 恢复加密备份
   - 恢复未加密备份
   - 验证消息正确恢复
   - 验证媒体文件正确恢复
   - 验证缩略图正确显示

### 性能测试

1. **大规模备份**
   - 100个会话
   - 每个会话1000条消息
   - 验证内存稳定
   - 验证进度正常更新

2. **大量媒体文件**
   - 1000个媒体文件
   - 总大小500MB+
   - 验证备份速度可接受
   - 验证恢复速度可接受

## 已解决的问题

### 1. 缩略图丢失

**问题**：图片消息备份后缩略图丢失

**原因**：`WFCCImageMessageContent.encode` 只在特定条件下保存缩略图

**解决**：手动检查并提取 thumbnail，转换为 JPEG

### 2. 媒体文件未恢复

**问题**：恢复时媒体文件路径不正确

**解决**：复制媒体文件到 app 的 sendbox 目录，设置正确的 localMediaPath

### 3. 全选按钮不更新UI

**问题**：点击全选后数据选中但UI未显示

**解决**：使用 table view 的 selectRowAtIndexPath 方法

### 4. 解密数据类型错误

**问题**：decryptData 期望 NSDictionary 但收到 NSData

**解决**：先解析 JSON 为字典，再传递给 decryptData

### 5. 取消备份留下不完整文件

**问题**：取消后备份目录不完整但未删除

**解决**：添加 currentBackupDirectory 跟踪，取消时递归删除

### 6. 媒体统计不准确

**问题**：统计了未实际备份的媒体文件

**解决**：只在 localMediaInfo 存在时才计数

## 未来改进方向

1. **增量备份**
   - 只备份新增消息
   - 减少备份时间

2. **压缩优化**
   - 使用 zip 格式打包
   - 压缩媒体文件

3. **云端备份**
   - 支持备份到 iCloud
   - 支持自定义服务器

4. **选择性恢复**
   - 选择某些会话恢复
   - 按时间范围恢复

## 总结

当前实现的备份系统具有以下特点：

✅ **结构清晰**：目录结构，每个会话独立
✅ **安全性好**：支持加密，可选密码保护
✅ **灵活性强**：支持选择性备份会话
✅ **用户友好**：进度反馈，统计信息，取消清理
✅ **性能优化**：内存管理，批量处理，线程安全
✅ **功能完整**：备份、恢复、加密、统计、列表管理

系统已可投入使用，建议进行充分的测试验证。
